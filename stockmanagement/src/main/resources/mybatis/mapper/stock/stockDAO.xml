<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.estock.stockmanagement.dao.stock.StockDAO">

    <resultMap type="StockAdapter" id="stockAdapter">
        <id property="id" column="id"/>
        <result property="productID" column="product_id"/>
        <result property="qty" column="qty"/>
        <result property="price" column="price"/>
    </resultMap>

    <resultMap type="ProductInStockAdapter" id="productInStockAdapter">
        <result property="productID" column="product_id"/>
        <result property="productName" column="name"/>
        <result property="totalQty" column="total_qty"/>
    </resultMap>


    <insert id="addNewStockIn">
        <![CDATA[
           INSERT INTO stock
            (
                id
                , product_id
                , qty
                , price
                , user_id
                , status
                , create_date
                , create_by
                , modify_date
                , modify_by
            )
            VALUES(
                #{id}
                , #{productID}
                , #{qty}
                , #{price}
                , #{userId}
                , #{stutas}
                , #{dateTime}
                , #{userId}
                , #{dateTime}
                , #{userId}
            );
        ]]>
    </insert>

    <update id="updateStockQty">
        <![CDATA[
            UPDATE product
			SET
				name= #{productName}
				, "desc"= #{desc}
				, modify_by=#{userId}
				, modify_date=#{dateTime}
				, status=#{stutas}
				, resource_id=#{resourceId}
			WHERE id = #{id};
        ]]>
    </update>

    <select id="inquiryByStockID" resultMap="stockAdapter">
        <![CDATA[
			SELECT 
				id
				, name
				, "desc"
				, create_by
				, create_date
				, modify_by
				, modify_date
				, status
				, resource_id
			FROM product;
	   ]]>
    </select>
    
    <select id="inquiryAllStock" resultMap="stockAdapter">
        <![CDATA[
			SELECT 
				id
				, name
				, "desc"
				, create_by
				, create_date
				, modify_by
				, modify_date
				, status
				, resource_id
			FROM product
			WHERE id = #{id};
	   ]]>
    </select>
    
    <select id="inquiryStockByProductId" resultMap="stockAdapter">
        <![CDATA[
			SELECT 
				id
				, name
				, "desc"
				, create_by
				, create_date
				, modify_by
				, modify_date
				, status
				, resource_id
			FROM product
			WHERE name = #{productName};
	   ]]>
    </select>
    
    <select id="count" resultType="java.lang.Integer">
        <![CDATA[
			select coalesce(MAX(id), 0) FROM  stock;
	   ]]>
    </select>

    <select id="inquiryProductInStock" resultMap="productInStockAdapter">
        <![CDATA[
			SELECT
            s.product_id,
            pro.name,
            SUM (s.qty) AS total_qty FROM stock AS s
            INNER JOIN product AS pro on pro."id" = s.product_id
            WHERE s.user_id = #{userID} and s.status != 'U'
            GROUP BY
                s.product_id,
                pro."name"
            ORDER BY total_qty;
	   ]]>
    </select>

    <select id="inquiryProductInStockByProductID" resultMap="productInStockAdapter">
        <![CDATA[
			SELECT
            s.product_id,
            pro.name,
            SUM (s.qty) AS total_qty FROM stock AS s
            INNER JOIN product AS pro on pro."id" = s.product_id
            WHERE s.user_id = #{userID} and s.status != 'U' and s.product_id = #{productID}
            GROUP BY
                s.product_id,
                pro."name"
            ORDER BY total_qty;
	   ]]>
    </select>
</mapper>